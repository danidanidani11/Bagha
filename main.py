import telebot, json, os, datetime, random
from flask import Flask, request
from telebot import types
from threading import Thread

API_TOKEN = '7459857250:AAHpb_NliuOiM7-cTmFSrospKdoKMnAFiew'
bot = telebot.TeleBot(API_TOKEN)
bot.set_my_commands([
    telebot.types.BotCommand("start", "شروع ربات"),
])
CHANNEL_USERNAME = "@bagha_game"
ADMIN_ID = 5542927340
TRON_ADDRESS = "TJ4xrwKJzKjk6FgKfuuqwah3Az5Ur22kJb"

app = Flask(__name__)

DATA_FILE = "users.json"
QUESTIONS_FILE = "questions.json"

if not os.path.exists(DATA_FILE):
    with open(DATA_FILE, "w") as f:
        json.dump({}, f)

# ✅ بارگذاری سوالات از فایل یا ساخت اولیه
if not os.path.exists(QUESTIONS_FILE):
    sample_questions = [ 
        {"question": "✈️ [مرحله 1] هواپیما سقوط کرده و شما در جنگلی تاریک هستید. اولین واکنش شما چیست؟",
"options": ["🏃 فرار می‌کنم", "🧭 نقشه می‌کشم", "🔥 آتش روشن می‌کنم", "😱 تسلیم می‌شوم"],
"answer": 2,
"explanations": {
"0": "فرار بدون هدف ممکن است باعث گم‌شدگی بیشتر شود.",
"1": "نقشه کشیدن بدون دید کافی بی‌فایده است.",
"2": "✅ روشن کردن آتش باعث دیده شدن توسط تیم نجات می‌شود.",
"3": "تسلیم شدن به معنای پایان تلاش برای بقا است."
}},

{"question": "🌧️ [مرحله 2] باران شدیدی شروع شده و آتشی که روشن کردید در حال خاموش شدن است. چه می‌کنید؟",
"options": ["🛡️ با برگ و چوب آتش را محافظت می‌کنم", "🏃 به دنبال پناهگاه می‌گردم", "💧 آب جمع می‌کنم", "😔 می‌نشینم و صبر می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ محافظت از آتش حیاتی است چون گرما و سیگنال را حفظ می‌کند.",
"1": "پناهگاه مهم است اما اگر آتش خاموش شود احتمال نجات کم می‌شود.",
"2": "جمع‌آوری آب مهم است ولی اولویت دوم دارد.",
"3": "صبر کردن بدون اقدام ممکن است شرایط را بدتر کند."
}},

{"question": "🥾 [مرحله 3] پای شما پیچ خورده و نمی‌توانید سریع حرکت کنید. چه کاری انجام می‌دهید؟",
"options": ["🩹 پا را بانداژ می‌کنم", "🚶‍♂️ ادامه می‌دهم", "🛌 استراحت می‌کنم", "📞 سعی می‌کنم با بی‌سیم تماس بگیرم"],
"answer": 0,
"explanations": {
"0": "✅ بانداژ کردن کمک به کاهش درد و جلوگیری از آسیب بیشتر می‌کند.",
"1": "ادامه حرکت بدون مراقبت ممکن است آسیب را شدیدتر کند.",
"2": "استراحت بدون درمان کافی ممکن است مفید نباشد.",
"3": "بی‌سیم ممکن است کار نکند و وقت تلف شود."
}},

{"question": "🌲 [مرحله 4] پس از درمان پا، صدای حیوانات وحشی نزدیک می‌شود. چه می‌کنید؟",
"options": ["🔥 آتش را بزرگ‌تر می‌کنم", "🏃 فرار می‌کنم", "🪵 چوب جمع می‌کنم", "🔕 ساکت می‌مانم"],
"answer": 0,
"explanations": {
"0": "✅ آتش بزرگ‌تر باعث دور شدن حیوانات می‌شود.",
"1": "فرار ممکن است باعث تعقیب حیوانات شود.",
"2": "جمع کردن چوب مفید است اما قبل از آن باید تهدید را دفع کنید.",
"3": "ساکت ماندن در برابر حیوانات وحشی خطرناک است."
}},

{"question": "🛖 [مرحله 5] باران شدید باعث خیس شدن وسایل و لباس‌ها شده است. چه کاری انجام می‌دهید؟",
"options": ["🏕️ به دنبال پناهگاه طبیعی می‌گردم", "🔥 آتش را خاموش می‌کنم", "👕 لباس‌ها را خشک می‌کنم", "🏃 به دنبال کمک می‌روم"],
"answer": 0,
"explanations": {
"0": "✅ پناهگاه طبیعی از شما در برابر باران محافظت می‌کند.",
"1": "خاموش کردن آتش باعث از دست رفتن گرما و سیگنال می‌شود.",
"2": "خشک کردن لباس‌ها اهمیت دارد اما اولویت پایین‌تری دارد.",
"3": "رفتن به دنبال کمک بدون برنامه‌ریزی ممکن است خطرناک باشد."
}},

{"question": "🔦 [مرحله 6] شب شده و باید جایی امن برای استراحت پیدا کنید. چه می‌کنید؟",
"options": ["🏕️ پناهگاه می‌سازم", "🔥 آتش را روشن نگه می‌دارم", "🌌 زیر آسمان باز می‌مانم", "🚶 به دنبال محل بهتر می‌روم"],
"answer": 0,
"explanations": {
"0": "✅ ساخت پناهگاه امنیت و محافظت در برابر سرما و حیوانات را فراهم می‌کند.",
"1": "حفظ آتش مهم است اما بدون پناهگاه کافی نیست.",
"2": "ماندن زیر آسمان باز خطرناک است و ممکن است دچار سرمازدگی شوید.",
"3": "جستجوی محل بهتر در شب خطرناک است."
}},

{"question": "🍓 [مرحله 7] برای تغذیه باید غذایی پیدا کنید. چه می‌خورید؟",
"options": ["🍓 میوه‌های جنگل", "🍄 قارچ‌های ناشناس", "🐜 حشرات", "🌿 برگ‌های سبز"],
"answer": 0,
"explanations": {
"0": "✅ میوه‌های شناخته شده منبع انرژی خوبی هستند.",
"1": "قارچ‌های ناشناس ممکن است سمی باشند.",
"2": "حشرات منبع پروتئین هستند ولی خوردن آنها ممکن است سخت باشد.",
"3": "برگ‌ها معمولاً قابل خوردن نیستند و ارزش غذایی کمی دارند."
}},

{"question": "🛑 [مرحله 8] مسیر پیش رو پر از دره و موانع است. بهترین راه ادامه چیست؟",
"options": ["⛰️ کوه‌نوردی سخت را انتخاب می‌کنم", "🛤️ دنبال مسیر هموار می‌گردم", "🚶‍♂️ مستقیم از دره رد می‌شوم", "🏃 فرار می‌کنم"],
"answer": 1,
"explanations": {
"0": "کوهنوردی سخت خطرناک است و ممکن است به شما آسیب برسد.",
"1": "✅ مسیر هموار امنیت و سرعت بیشتری دارد.",
"2": "رد شدن مستقیم از دره خطر سقوط دارد.",
"3": "فرار بدون هدف ممکن است شما را گمراه کند."
}},

{"question": "💧 [مرحله 9] آب آشامیدنی کافی ندارید. چه کاری انجام می‌دهید؟",
"options": ["🌧️ جمع کردن آب باران", "🚰 نوشیدن از رودخانه", "🌿 جوشاندن آب", "🥤 نوشیدن آب از برگ‌ها"],
"answer": 2,
"explanations": {
"0": "جمع‌آوری آب باران امن و پاک است ولی ممکن است کم باشد.",
"1": "نوشیدن مستقیم از رودخانه ممکن است باعث بیماری شود.",
"2": "✅ جوشاندن آب باعث از بین رفتن میکروب‌ها می‌شود.",
"3": "آب برگ‌ها مقدار کمی دارد و ممکن است آلوده باشد."
}},

{"question": "🚩 [مرحله 10] برای جلب توجه نجات‌دهندگان، چه سیگنالی ارسال می‌کنید؟",
"options": ["🔥 دود غلیظ از آتش", "📢 فریاد بلند", "💡 چراغ قوه", "🪵 چوب‌های کنار هم چیده شده"],
"answer": 0,
"explanations": {
"0": "✅ دود غلیظ و زیاد به آسانی دیده می‌شود.",
"1": "فریاد زدن انرژی زیادی می‌برد و ممکن است بی‌اثر باشد.",
"2": "چراغ قوه اگر شب باشد مفید است اما باتری محدود است.",
"3": "چیدن چوب‌ها ممکن است دیده نشود."
}},

{"question": "🕵️‍♂️ [مرحله 11] رد پاهای تازه در اطراف محل کمپ می‌بینید. چه می‌کنید؟",
"options": ["🚶‍♂️ رد پا را دنبال می‌کنم", "🛑 محل را علامت می‌زنم", "🏃 پنهان می‌شوم", "🔊 فریاد می‌زنم"],
"answer": 1,
"explanations": {
"0": "دنبال کردن رد پا بدون شناخت ممکن است خطرناک باشد.",
"1": "✅ علامت‌گذاری محل کمک می‌کند مسیر را گم نکنید.",
"2": "پنهان شدن ممکن است فرصت کمک را از دست بدهد.",
"3": "فریاد ممکن است توجه حیوانات یا افراد خطرناک را جلب کند."
}},

{"question": "🌄 [مرحله 12] تصمیم می‌گیرید از کمپ خارج شوید و منطقه‌ای بلندتر برای دید بهتر پیدا کنید. چه می‌کنید؟",
"options": ["🧗 از کوه بالا می‌روم", "🚶 مسیر هموار را انتخاب می‌کنم", "🏞️ کنار رودخانه می‌روم", "🏃 سریع حرکت می‌کنم"],
"answer": 1,
"explanations": {
"0": "کوهنوردی خطرناک است و انرژی زیادی می‌برد.",
"1": "✅ مسیر هموار امنیت و استقامت بهتری دارد.",
"2": "کنار رودخانه ممکن است خطراتی داشته باشد مثل سیلاب.",
"3": "حرکت سریع بدون نقشه احتمال گم شدن را افزایش می‌دهد."
}},

{"question": "⚠️ [مرحله 13] هوا سرد شده و احساس سرما می‌کنید. چه کاری می‌کنید؟",
"options": ["🔥 آتش را بزرگ‌تر می‌کنم", "🧥 لباس‌های اضافی می‌پوشم", "🏕️ پناهگاه می‌سازم", "🚶 حرکت می‌کنم تا گرم شوم"],
"answer": 2,
"explanations": {
"0": "آتش مهم است ولی پناهگاه گرما را بهتر حفظ می‌کند.",
"1": "پوشیدن لباس اضافی کمک می‌کند ولی اگر پناهگاه نباشد کافی نیست.",
"2": "✅ ساخت پناهگاه محافظت بهتری در برابر سرما فراهم می‌کند.",
"3": "حرکت ممکن است انرژی را سریع‌تر تخلیه کند."
}},

{"question": "🌾 [مرحله 14] گیاهان خوراکی جنگل را شناسایی می‌کنید. چه کاری می‌کنید؟",
"options": ["🍓 میوه‌های شناخته شده می‌خورم", "🍄 قارچ‌های ناشناس را امتحان می‌کنم", "🌿 هر گیاهی را می‌خورم", "🥜 دانه‌های جنگل را جمع می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ خوردن میوه‌های شناخته شده ایمن‌تر است.",
"1": "قارچ‌های ناشناس ممکن است سمی باشند.",
"2": "خوردن هر گیاهی بدون شناخت خطرناک است.",
"3": "جمع‌آوری دانه‌ها خوب است اما نیاز به پردازش دارد."
}},

{"question": "🦟 [مرحله 15] حشرات زیادی شما را اذیت می‌کنند. بهترین راه مقابله چیست؟",
"options": ["🔥 آتش را بزرگ‌تر می‌کنم", "🧴 از مواد دفع حشرات استفاده می‌کنم", "🛌 در پناهگاه می‌مانم", "🚶 دور می‌شوم"],
"answer": 1,
"explanations": {
"0": "آتش کمک می‌کند اما کافی نیست.",
"1": "✅ مواد دفع حشرات موثرترین راه است.",
"2": "ماندن در پناهگاه تنها راه نیست.",
"3": "دور شدن ممکن است باعث گم‌شدگی شود."
}},

{"question": "🛠️ [مرحله 16] می‌خواهید ابزاری برای شکار یا دفاع بسازید. از چه چیزی استفاده می‌کنید؟",
"options": ["🪓 چوب و سنگ", "🧵 پارچه و چوب", "🗡️ فلزهای هواپیما", "🌿 گیاهان"],
"answer": 2,
"explanations": {
"0": "چوب و سنگ ابتدایی است ولی کم کاربرد.",
"1": "پارچه و چوب ابزاری مقاوم نمی‌سازد.",
"2": "✅ فلزهای هواپیما بهترین ابزارها را می‌سازند.",
"3": "گیاهان برای ابزارسازی مناسب نیستند."
}},

{"question": "👀 [مرحله 17] در دوردست‌ها دود می‌بینید، چه می‌کنید؟",
"options": ["🚶 به سمت دود می‌روم", "🏕️ پناهگاه را ترک نمی‌کنم", "📞 سعی می‌کنم با بی‌سیم تماس بگیرم", "🚩 سیگنال می‌فرستم"],
"answer": 0,
"explanations": {
"0": "✅ دنبال کردن دود ممکن است به نجات کمک کند.",
"1": "ماندن ممکن است فرصت نجات را از دست بدهد.",
"2": "بی‌سیم ممکن است کار نکند.",
"3": "سیگنال دادن خوب است اما اگر تنها باشید کافی نیست."
}},

{"question": "🌪️ [مرحله 18] طوفان نزدیک می‌شود، چه کاری انجام می‌دهید؟",
"options": ["🏕️ پناهگاه محکم می‌سازم", "🔥 آتش را خاموش می‌کنم", "🚶 دور می‌شوم", "😰 هیچ کاری نمی‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ پناهگاه محکم شما را در برابر طوفان محافظت می‌کند.",
"1": "خاموش کردن آتش ممکن است گرما و سیگنال را از بین ببرد.",
"2": "دور شدن در طوفان خطرناک است.",
"3": "هیچ کاری نکردن شرایط را بدتر می‌کند."
}},

{"question": "🔦 [مرحله 19] باتری چراغ قوه‌تان تمام شده است. بهترین راه برای دید در شب چیست؟",
"options": ["🔥 آتش را نگه می‌دارم", "🌙 به ماه نگاه می‌کنم", "🏕️ از فلاش گوشی استفاده می‌کنم", "🛌 استراحت می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ آتش بهترین منبع نور و گرماست.",
"1": "نور ماه کافی نیست.",
"2": "اگر باتری تمام شده باشد فلاش کار نمی‌کند.",
"3": "استراحت بدون نور ممکن است خطرناک باشد."
}},

{"question": "📦 [مرحله 20] به جعبه کمک‌های اولیه هواپیما دسترسی پیدا می‌کنید. چه چیزی را در اولویت استفاده قرار می‌دهید؟",
"options": ["🩹 بانداژ و ضدعفونی", "💊 داروهای ضد درد", "🩺 تجهیزات معاینه", "🥤 نوشیدنی‌های انرژی‌زا"],
"answer": 0,
"explanations": {
"0": "✅ بانداژ و ضدعفونی برای جلوگیری از عفونت حیاتی است.",
"1": "داروهای ضد درد مفیدند اما اولویت پایین‌تری دارند.",
"2": "معاینه مهم است ولی نیازمند تخصص است.",
"3": "نوشیدنی انرژی‌زا کمک کننده است ولی درمان نیست."
}},

{"question": "🧭 [مرحله 21] تصمیم می‌گیرید جهت شمال را پیدا کنید. بهترین روش چیست؟",
"options": ["☀️ استفاده از موقعیت خورشید", "🧭 استفاده از قطب‌نما", "⭐ نگاه کردن به ستارگان", "🚶 از حس جهت‌یابی استفاده می‌کنم"],
"answer": 1,
"explanations": {
"0": "خورشید می‌تواند کمک کند اما در ابرها کارایی ندارد.",
"1": "✅ قطب‌نما دقیق‌ترین روش است.",
"2": "ستارگان در شب کمک می‌کنند اما نیازمند دانش است.",
"3": "حس جهت‌یابی ممکن است اشتباه باشد."
}},

{"question": "🌿 [مرحله 22] زخمی در دست دارید که عفونت کرده است. چه کاری می‌کنید؟",
"options": ["🩹 ضدعفونی و پانسمان", "🚫 دست را حرکت نمی‌دهم", "💊 آنتی‌بیوتیک مصرف می‌کنم", "🛌 استراحت می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ ضدعفونی و پانسمان برای کنترل عفونت ضروری است.",
"1": "بی‌حرکتی تنها کافی نیست.",
"2": "آنتی‌بیوتیک در دسترس نیست مگر داشته باشید.",
"3": "استراحت مفید است ولی کافی نیست."
}},

{"question": "🐍 [مرحله 23] مار سمی در نزدیکی کمپ دیده‌اید، بهترین واکنش چیست؟",
"options": ["🏃 فرار می‌کنم", "🛡️ فاصله می‌گیرم و مراقب هستم", "🔪 حمله می‌کنم", "🛌 در پناهگاه می‌مانم"],
"answer": 1,
"explanations": {
"0": "فرار سریع ممکن است باعث تحریک مار شود.",
"1": "✅ حفظ فاصله و هوشیاری بهترین راه است.",
"2": "حمله به مار خطرناک است و ممکن است موجب گزش شود.",
"3": "ماندن در پناهگاه بدون اقدام ممکن است خطرناک باشد."
}},

{"question": "🌄 [مرحله 24] صبح شده و هوا آفتابی است. چه کاری انجام می‌دهید؟",
"options": ["🚶 مسیر جدیدی برای گشت‌زنی انتخاب می‌کنم", "🛌 در کمپ می‌مانم", "🔥 آتش را تقویت می‌کنم", "💧 آب جمع می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ گشت‌زنی در روز فرصت پیدا کردن منابع بیشتر را می‌دهد.",
"1": "ماندن در کمپ ممکن است فرصت‌ها را محدود کند.",
"2": "تقویت آتش مهم است ولی اولویت کمتری نسبت به گشت‌زنی دارد.",
"3": "جمع‌آوری آب مهم است اما بهتر است در کنار گشت‌زنی انجام شود."
}},

{"question": "🦌 [مرحله 25] ردپای حیوانی بزرگ پیدا می‌کنید. چه تصمیمی می‌گیرید؟",
"options": ["🚶 ردپا را دنبال می‌کنم", "🛑 از مسیر رد پا دور می‌شوم", "🔥 آتش روشن می‌کنم", "🏃 فرار می‌کنم"],
"answer": 1,
"explanations": {
"0": "تعقیب حیوانات بزرگ خطرناک است.",
"1": "✅ دور ماندن از مسیر رد پا امنیت بیشتری دارد.",
"2": "آتش ممکن است حیوانات را دور کند اما کافی نیست.",
"3": "فرار بدون برنامه می‌تواند خطرناک باشد."
}},

{"question": "🔪 [مرحله 26] برای دفاع از خود، چه سلاحی می‌سازید؟",
"options": ["🪓 چوب تیز", "🗡️ فلزهای هواپیما", "🧵 پارچه و چوب", "🪶 پر و چوب"],
"answer": 1,
"explanations": {
"0": "چوب تیز ابتدایی است ولی محدودیت دارد.",
"1": "✅ استفاده از فلزهای هواپیما سلاح موثر می‌سازد.",
"2": "پارچه و چوب مقاومت کمی دارند.",
"3": "پر و چوب سلاح مناسبی نیست."
}},

{"question": "🌪️ [مرحله 27] طوفان شدید نزدیک می‌شود، بهترین اقدام چیست؟",
"options": ["🏕️ پناهگاه محکم می‌سازم", "🔥 آتش را خاموش می‌کنم", "🚶 دور می‌شوم", "😰 هیچ کاری نمی‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ پناهگاه محکم در طوفان محافظت می‌کند.",
"1": "خاموش کردن آتش گرما و سیگنال را از بین می‌برد.",
"2": "دور شدن در طوفان خطرناک است.",
"3": "هیچ کاری نکردن شرایط را بدتر می‌کند."
}},

{"question": "🐍 [مرحله 28] مار سمی به شما حمله کرده، چه می‌کنید؟",
"options": ["🩹 محل گزش را بانداژ می‌کنم", "🏃 فرار می‌کنم", "🔪 زخم را می‌برم", "🛌 بی‌حرکت می‌مانم"],
"answer": 0,
"explanations": {
"0": "✅ بانداژ و مراقبت اولیه مهم است.",
"1": "فرار بعد از گزش کمک نمی‌کند.",
"2": "برش زخم خطرناک است و توصیه نمی‌شود.",
"3": "بی‌حرکت ماندن بدون مراقبت کافی نیست."
}},

{"question": "📢 [مرحله 29] صدای کمک می‌شنوید، چه می‌کنید؟",
"options": ["🚶 به سمت صدا می‌روم", "🛑 منتظر می‌مانم", "🔥 آتش روشن می‌کنم", "🔊 فریاد می‌زنم"],
"answer": 0,
"explanations": {
"0": "✅ حرکت به سمت صدا احتمال نجات را افزایش می‌دهد.",
"1": "منتظر ماندن ممکن است فرصت‌ها را از دست بدهد.",
"2": "آتش روشن کردن کمک می‌کند اما باید نزدیک شوید.",
"3": "فریاد زدن ممکن است انرژی زیادی مصرف کند."
}},

{"question": "🪓 [مرحله 30] برای ساخت پناهگاه به ابزار نیاز دارید. بهترین گزینه چیست؟",
"options": ["🗡️ فلزهای هواپیما", "🪵 چوب‌های خشک", "🧵 پارچه‌ها", "🌿 برگ‌ها"],
"answer": 0,
"explanations": {
"0": "✅ فلزهای هواپیما بهترین ابزار را فراهم می‌کنند.",
"1": "چوب خشک مفید است اما ابزار نیست.",
"2": "پارچه برای پوشش است نه ابزار.",
"3": "برگ‌ها ابزار نیستند."
}},

{"question": "🌌 [مرحله 31] شب سرد است، چه کاری می‌کنید؟",
"options": ["🔥 آتش را تقویت می‌کنم", "🛌 داخل پناهگاه می‌مانم", "🏃 بیرون می‌روم", "🧥 لباس اضافی می‌پوشم"],
"answer": 0,
"explanations": {
"0": "✅ آتش بهترین منبع گرماست.",
"1": "پناهگاه مهم است اما گرما کم است.",
"2": "بیرون رفتن در شب سرد خطرناک است.",
"3": "لباس اضافی کمک می‌کند اما کافی نیست."
}},

{"question": "📡 [مرحله 32] بی‌سیم شکسته، چه کاری می‌کنید؟",
"options": ["🔧 تعمیر می‌کنم", "🚫 رها می‌کنم", "🛠️ از فلز هواپیما کمک می‌گیرم", "📞 تلاش می‌کنم تماس بگیرم"],
"answer": 2,
"explanations": {
"0": "تعمیر ممکن است سخت باشد اما باید تلاش کرد.",
"1": "رها کردن فرصت نجات را کاهش می‌دهد.",
"2": "✅ استفاده از فلز برای تعمیر منطقی است.",
"3": "تماس بدون دستگاه سالم ممکن نیست."
}},

{"question": "🌿 [مرحله 33] گیاه سمی خورده‌اید، چه کاری می‌کنید؟",
"options": ["🚰 آب زیاد می‌نوشم", "🏃 به دنبال کمک می‌روم", "🩹 از جعبه کمک‌های اولیه استفاده می‌کنم", "🛌 استراحت می‌کنم"],
"answer": 2,
"explanations": {
"0": "نوشیدن آب کمک کننده است اما کافی نیست.",
"1": "کمک گرفتن خوب است اما ممکن است دسترسی نداشته باشید.",
"2": "✅ استفاده از جعبه کمک‌های اولیه بهترین کار است.",
"3": "استراحت تنها کافی نیست."
}},

{"question": "🐾 [مرحله 34] حیوان وحشی به سمت کمپ نزدیک می‌شود، چه می‌کنید؟",
"options": ["🔥 آتش را بزرگ‌تر می‌کنم", "🏃 فرار می‌کنم", "🛡️ دفاع می‌کنم", "🔕 ساکت می‌مانم"],
"answer": 0,
"explanations": {
"0": "✅ آتش بزرگ‌تر باعث دور شدن حیوان می‌شود.",
"1": "فرار ممکن است حیوان را تحریک کند.",
"2": "دفاع ممکن است خطرناک باشد.",
"3": "ساکت ماندن در برابر حیوانات وحشی خطرناک است."
}},

{"question": "🧭 [مرحله 35] جهت‌یابی سخت شده است. چه کاری انجام می‌دهید؟",
"options": ["🧭 قطب‌نما را چک می‌کنم", "🚶 به حس جهت‌یابی خود اعتماد می‌کنم", "🌟 ستارگان را نگاه می‌کنم", "🚫 هیچ کاری نمی‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ قطب‌نما دقیق‌ترین راه است.",
"1": "حس جهت‌یابی ممکن است اشتباه باشد.",
"2": "نگاه کردن به ستارگان نیاز به دانش دارد.",
"3": "انجام ندادن کاری باعث گم شدن بیشتر می‌شود."
}},

{"question": "🌄 [مرحله 36] خوراکی کمی دارید، چه کاری می‌کنید؟",
"options": ["🍓 میوه‌های جنگل جمع می‌کنم", "🍄 قارچ‌های ناشناس می‌خورم", "🐜 حشرات می‌خورم", "🥤 صبر می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ میوه‌های شناخته شده امن‌تر هستند.",
"1": "قارچ‌های ناشناس ممکن است سمی باشند.",
"2": "حشرات منبع پروتئین‌اند اما ممکن است سخت باشند.",
"3": "صبر کردن بدون غذا خطرناک است."
}},

{"question": "🛠️ [مرحله 37] برای ساخت سلاح از چه استفاده می‌کنید؟",
"options": ["🪓 چوب و سنگ", "🗡️ فلز هواپیما", "🧵 پارچه و چوب", "🌿 برگ و چوب"],
"answer": 1,
"explanations": {
"0": "چوب و سنگ ابتدایی است ولی محدودیت دارد.",
"1": "✅ فلز هواپیما بهترین گزینه است.",
"2": "پارچه و چوب مقاومت کمی دارند.",
"3": "برگ‌ها ابزار مناسبی نیستند."
}},

{"question": "📞 [مرحله 38] تلاش می‌کنید تماس بگیرید اما سیگنال ندارید، چه می‌کنید؟",
"options": ["🚶 به منطقه بلندتر می‌روم", "🛌 منتظر می‌مانم", "🔥 آتش روشن می‌کنم", "🔊 فریاد می‌زنم"],
"answer": 0,
"explanations": {
"0": "✅ بالا رفتن از ارتفاع ممکن است سیگنال را بهتر کند.",
"1": "منتظر ماندن ممکن است باعث از دست رفتن فرصت‌ها شود.",
"2": "آتش روشن کردن کمک می‌کند اما باید منطقه امن باشد.",
"3": "فریاد زدن انرژی زیادی مصرف می‌کند."
}},

{"question": "🪵 [مرحله 39] چوب خشک کافی ندارید، چه می‌کنید؟",
"options": ["🌲 چوب‌های تر را خشک می‌کنم", "🚶 دنبال چوب می‌روم", "🔥 آتش را خاموش می‌کنم", "🛌 استراحت می‌کنم"],
"answer": 1,
"explanations": {
"0": "خشک کردن چوب تر وقت‌گیر است.",
"1": "✅ جمع‌آوری چوب خشک بهترین گزینه است.",
"2": "خاموش کردن آتش گرما و سیگنال را از بین می‌برد.",
"3": "استراحت بدون گرما خطرناک است."
}},

{"question": "🍂 [مرحله 40] برگ‌های خشک را برای چه استفاده می‌کنید؟",
"options": ["🔥 آتش روشن می‌کنم", "🛏️ زیر پناهگاه می‌گذارم", "🍽️ خوراکی می‌سازم", "🚶 دور می‌شوم"],
"answer": 0,
"explanations": {
"0": "✅ برگ خشک به عنوان ماده سوختی عالی است.",
"1": "استفاده به عنوان زیرانداز مفید است ولی اولویت پایین‌تری دارد.",
"2": "برگ خوراکی نیست.",
"3": "دور شدن بی‌هدف مفید نیست."
}},

{"question": "🛖 [مرحله 41] می‌خواهید پناهگاه را بزرگ‌تر کنید. بهترین راه چیست؟",
"options": ["🪵 چوب بیشتری جمع کنم", "🌿 برگ‌های بیشتری اضافه کنم", "🧱 سنگ کنار هم بچینم", "🚶 خارج از کمپ می‌روم"],
"answer": 0,
"explanations": {
"0": "✅ جمع‌آوری چوب بیشتر برای ساخت بهتر ضروری است.",
"1": "افزودن برگ مفید است اما به تنهایی کافی نیست.",
"2": "سنگ برای ساخت پناهگاه جنگلی کاربردی کمتر دارد.",
"3": "رفتن خارج از کمپ ممکن است خطرناک باشد."
}},

{"question": "🔥 [مرحله 42] آتش کم‌سو شده، چه می‌کنید؟",
"options": ["🪵 چوب خشک اضافه می‌کنم", "💧 آب روی آتش می‌ریزم", "🛌 استراحت می‌کنم", "🚶 دنبال مواد جدید می‌روم"],
"answer": 0,
"explanations": {
"0": "✅ اضافه کردن چوب خشک آتش را تقویت می‌کند.",
"1": "ریختن آب آتش را خاموش می‌کند.",
"2": "استراحت بدون آتش خطرناک است.",
"3": "رفتن به دنبال مواد خوب است ولی ابتدا باید آتش را حفظ کرد."
}},

{"question": "🥤 [مرحله 43] احساس تشنگی شدید دارید. چه کاری انجام می‌دهید؟",
"options": ["🌧️ جمع‌آوری آب باران", "🚰 نوشیدن از رودخانه", "🥤 آب داخل بطری پیدا می‌کنم", "🌿 آب برگ‌ها را می‌گیرم"],
"answer": 0,
"explanations": {
"0": "✅ آب باران تمیزتر و امن‌تر است.",
"1": "آب رودخانه ممکن است آلوده باشد.",
"2": "یافتن بطری آب احتمالا دشوار است.",
"3": "آب برگ‌ها مقدار کمی دارد و ممکن است آلوده باشد."
}},

{"question": "🦌 [مرحله 44] حیوان بزرگ شکار می‌کنید. بهترین روش چیست؟",
"options": ["🗡️ با سلاح ساخته شده حمله می‌کنم", "🔥 آتش دور می‌کنم", "🚶 دور می‌شوم", "🛌 صبر می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ استفاده از سلاح مناسب برای شکار موثر است.",
"1": "آتش شکار را دور می‌کند.",
"2": "دور شدن شکار را از دست می‌دهید.",
"3": "صبر کردن بدون اقدام بی‌فایده است."
}},

{"question": "🌙 [مرحله 45] شب سرد و تاریک است، چه می‌کنید؟",
"options": ["🔥 آتش روشن می‌کنم", "🛌 پناهگاه می‌سازم", "🚶 به دنبال محل گرم می‌روم", "🧥 لباس‌های گرم می‌پوشم"],
"answer": 0,
"explanations": {
"0": "✅ آتش مهم‌ترین منبع گرماست.",
"1": "پناهگاه محافظ است ولی بدون آتش کافی نیست.",
"2": "حرکت در شب خطرناک است.",
"3": "لباس گرم مهم است اما آتش ضروری‌تر است."
}},

{"question": "🩹 [مرحله 46] زخمی شدید دارید، چه کاری می‌کنید؟",
"options": ["🩹 زخم را پانسمان می‌کنم", "🏃 به دنبال کمک می‌روم", "🛌 استراحت می‌کنم", "🔪 زخم را می‌برم"],
"answer": 0,
"explanations": {
"0": "✅ پانسمان برای جلوگیری از عفونت حیاتی است.",
"1": "رفتن به دنبال کمک ممکن است خطرناک باشد.",
"2": "استراحت بدون درمان کافی نیست.",
"3": "برش زخم خطرناک است."
}},

{"question": "📡 [مرحله 47] بی‌سیم کار نمی‌کند، بهترین اقدام چیست؟",
"options": ["🔧 تعمیر می‌کنم", "🚶 به منطقه بلندتر می‌روم", "🔥 آتش روشن می‌کنم", "🛌 منتظر می‌مانم"],
"answer": 1,
"explanations": {
"0": "تعمیر ممکن است سخت باشد.",
"1": "✅ رفتن به منطقه بلندتر ممکن است سیگنال بهتر دهد.",
"2": "آتش کمک می‌کند اما تماس برقرار نمی‌کند.",
"3": "منتظر ماندن زمان را از دست می‌دهد."
}},

{"question": "🌧️ [مرحله 48] باران شدید باعث سیل شدن رودخانه شده، چه کاری می‌کنید؟",
"options": ["🚶 مسیر خود را تغییر می‌دهم", "🏕️ در جای خود می‌مانم", "🔥 آتش خاموش می‌کنم", "🛌 استراحت می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ تغییر مسیر برای اجتناب از سیل ضروری است.",
"1": "ماندن ممکن است خطرناک باشد.",
"2": "خاموش کردن آتش گرما و سیگنال را از بین می‌برد.",
"3": "استراحت در شرایط خطرناک مناسب نیست."
}},

{"question": "🍃 [مرحله 49] برگ‌های بزرگ را برای چه استفاده می‌کنید؟",
"options": ["🏕️ ساخت پناهگاه", "🔥 آتش", "🥤 جمع‌آوری آب", "🧴 استفاده به عنوان دارو"],
"answer": 2,
"explanations": {
"0": "برگ‌های بزرگ به ساخت پناهگاه کمک می‌کنند ولی هدف اصلی نیستند.",
"1": "برگ‌ها به عنوان سوخت کمتر استفاده می‌شوند.",
"2": "✅ برگ‌های بزرگ برای جمع‌آوری آب مناسب‌اند.",
"3": "برگ‌ها دارو نیستند."
}},

{"question": "🦟 [مرحله 50] حشرات شما را اذیت می‌کنند، بهترین راه چیست؟",
"options": ["🔥 آتش را بزرگ‌تر می‌کنم", "🧴 از مواد دفع حشرات استفاده می‌کنم", "🏕️ پناهگاه را محکم‌تر می‌کنم", "🚶 دور می‌شوم"],
"answer": 1,
"explanations": {
"0": "آتش کمک می‌کند اما کافی نیست.",
"1": "✅ مواد دفع حشرات موثرترین راه است.",
"2": "محکم‌تر کردن پناهگاه خوب است ولی به تنهایی کافی نیست.",
"3": "دور شدن ممکن است باعث گم‌شدگی شود."
}},

{
"question": "🚁 [مرحله 51] صدای بالگرد در آسمان شنیده می‌شود اما دیده نمی‌شود. چه می‌کنید؟",
"options": ["🔥 دود زیادی تولید می‌کنم", "📢 فریاد می‌زنم", "🚶 به بالای کوه می‌روم", "💡 از چراغ قوه استفاده می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ دود غلیظ در روز بهترین روش جلب توجه بالگرد است.",
"1": "فریاد شنیده نمی‌شود مگر خیلی نزدیک باشد.",
"2": "بالا رفتن مفید است اما وقت‌بر و خطرناک.",
"3": "چراغ قوه در روز کاربرد ندارد."
}
},
{
"question": "🧨 [مرحله 52] جرقه‌ای خطرناک در نزدیکی مواد اشتعال‌زا می‌بینی. واکنش سریع چیست؟",
"options": ["🪣 روی آن آب می‌ریزم", "🚫 مواد را دور می‌کنم", "🏃 فرار می‌کنم", "🔥 آتش را خاموش می‌کنم"],
"answer": 1,
"explanations": {
"0": "آب شاید مؤثر نباشد، باید اول منبع را حذف کرد.",
"1": "✅ دور کردن مواد اشتعال‌زا از جرقه بهترین اقدام است.",
"2": "فرار بدون اقدام ممکن است باعث آتش‌سوزی شود.",
"3": "خاموش کردن آتش باید بعد از حذف خطر انجام شود."
}
},
{
"question": "📜 [مرحله 53] دفترچه‌ای با نقشه جنگل پیدا می‌کنی. بهترین کار چیست؟",
"options": ["📖 آن را دقیق بررسی می‌کنم", "🧭 با قطب‌نما مطابقت می‌دهم", "🔥 از آن برای آتش استفاده می‌کنم", "🛌 آن را نگه می‌دارم برای بعد"],
"answer": 0,
"explanations": {
"0": "✅ بررسی دقیق نقشه مسیر نجات را ممکن می‌سازد.",
"1": "مقایسه با قطب‌نما خوب است اما اول باید بررسی کرد.",
"2": "سوزاندن آن اشتباه بزرگی است.",
"3": "نگه داشتن بدون استفاده از اطلاعاتش بی‌فایده است."
}
},
{
"question": "🐾 [مرحله 54] روی نقشه منطقه‌ای با علامت «ممنوع» دیده می‌شود. چه تصمیمی می‌گیری؟",
"options": ["🚫 از آن دور می‌مانم", "🚶 از آن عبور می‌کنم", "🔍 ابتدا بررسی می‌کنم", "😐 نادیده می‌گیرم"],
"answer": 2,
"explanations": {
"0": "ممکن است اطلاعات بیشتری لازم باشد.",
"1": "عبور مستقیم خطرناک است.",
"2": "✅ بررسی منطقی قبل از تصمیم‌گیری ضروری است.",
"3": "نادیده گرفتن آن ممکن است منجر به خطر شود."
}
},
{
"question": "🧊 [مرحله 55] شب‌هنگام دمای هوا به‌شدت پایین آمده. چه اقدامی برای حفظ گرما انجام می‌دهی؟",
"options": ["🔥 آتش را تقویت می‌کنم", "🛏️ در برگ‌ها می‌پیچم", "👕 لباس‌های خیس را درمی‌آورم", "🛌 پناهگاه را کیپ‌تر می‌کنم"],
"answer": 3,
"explanations": {
"0": "آتش مهم است ولی باید حرارت در پناهگاه بماند.",
"1": "برگ‌ها کمک می‌کنند اما کافی نیستند.",
"2": "درآوردن لباس خیس ضروری است اما باید همراه با گرمایش باشد.",
"3": "✅ کیپ کردن پناهگاه باعث حفظ بهتر گرما می‌شود."
}
},
{
"question": "📦 [مرحله 56] جعبه‌ای در لاشه هواپیما پیدا می‌کنی که قفل است. چه کار می‌کنی؟",
"options": ["🔨 آن را با سنگ می‌شکنم", "🗝️ دنبال کلید می‌گردم", "🛑 دست نمی‌زنم", "🔥 می‌سوزانم تا باز شود"],
"answer": 0,
"explanations": {
"0": "✅ شکستن با سنگ سریع‌ترین راه برای باز کردن است.",
"1": "دنبال کلید گشتن زمان‌بر است.",
"2": "نادیده گرفتن ممکن است فرصت را از دست بدهی.",
"3": "سوزاندن ممکن است محتوا را نابود کند."
}
},
{
"question": "🥩 [مرحله 57] غذایی شکار کرده‌ای، اما خام است. چه می‌کنی؟",
"options": ["🔥 کاملاً می‌پزم", "🥩 خام می‌خورم", "🧊 در هوای سرد نگه می‌دارم", "🧂 با گیاهان ادویه‌اش می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ پخت کامل از بیماری جلوگیری می‌کند.",
"1": "خوردن خام خطر آلودگی دارد.",
"2": "نگهداری تنها کافی نیست.",
"3": "ادویه‌دار کردن ارزش دارد ولی بعد از پخت."
}
},
{
"question": "👃 [مرحله 58] بوی دود ناشناخته‌ای به مشامت می‌رسد. واکنش درست چیست؟",
"options": ["🚶 به سمت دود می‌روید", "🛑 صبر می‌کنید", "🔭 از بلندی بررسی می‌کنید", "📢 فریاد می‌زنید"],
"answer": 2,
"explanations": {
"0": "حرکت کورکورانه ممکن است خطرناک باشد.",
"1": "صبر باعث از دست رفتن زمان می‌شود.",
"2": "✅ بررسی از بلندی اطلاعات بهتری می‌دهد.",
"3": "فریاد زدن ممکن است بی‌فایده باشد."
}
},
{
"question": "🎯 [مرحله 59] باید یک تله برای شکار بگذارید. بهترین مکان کجاست؟",
"options": ["🐾 مسیر رد پای حیوانات", "🌳 زیر درخت بزرگ", "🏕️ نزدیک پناهگاه", "🏞️ کنار آب"],
"answer": 0,
"explanations": {
"0": "✅ مسیر ردپاها بهترین احتمال شکار را دارد.",
"1": "درخت لزوماً محل عبور نیست.",
"2": "نزدیکی به کمپ خطرساز است.",
"3": "کنار آب خوب است ولی باید اثر رد پا را دید."
}
},
{
"question": "📡 [مرحله 60] سیگنال نجاتی ضعیف دریافت می‌کنی. چه می‌کنی؟",
"options": ["🚶 به همان جهت حرکت می‌کنم", "📍 محل را علامت می‌زنم", "📞 پیام می‌فرستم", "🛌 صبر می‌کنم"],
"answer": 2,
"explanations": {
"0": "حرکت ممکن است باعث از بین رفتن سیگنال شود.",
"1": "علامت‌گذاری خوب است ولی اولویت ندارد.",
"2": "✅ در اولین فرصت باید پیام یا سیگنال ارسال کرد.",
"3": "صبر کردن بدون ارسال پیام ممکن است بی‌فایده باشد."
}
},
{
"question": "🎒 [مرحله 61] کوله‌پشتی‌ات پاره شده. چه کار می‌کنی؟",
"options": ["🪡 با پارچه و نخ می‌دوزم", "🗑️ دور می‌اندازم", "🧵 با برگ و چوب تعمیر می‌کنم", "🧷 گره می‌زنم"],
"answer": 0,
"explanations": {
"0": "✅ تعمیر با پارچه و نخ محکم‌تر و بادوام‌تر است.",
"1": "دور انداختن وسایل ارزشمند نیست.",
"2": "برگ و چوب موقتی و ناکارآمدند.",
"3": "گره موقتی است اما برای دوام کافی نیست."
}
},
{
"question": "🔋 [مرحله 76] باتری چراغ‌قوه ضعیف شده است. چه زمانی از آن استفاده می‌کنی؟",
"options": ["🌑 فقط در شب‌های کاملاً تاریک", "🔦 مدام روشن نگه می‌دارم", "🕵️‍♂️ هنگام جست‌وجو در روز", "📢 برای علامت دادن"],
"answer": 0,
"explanations": {
"0": "✅ در مواقع ضروری شبانه استفاده شود تا باتری حفظ گردد.",
"1": "مصرف بی‌رویه باعث تمام شدن باتری می‌شود.",
"2": "در روز نیازی به چراغ‌قوه نیست.",
"3": "علامت دادن با صدا یا دود بهتر است."
}
},
{
"question": "🧪 [مرحله 77] آبی پیدا کرده‌ای که رنگ آن کمی کدر است. چه می‌کنی؟",
"options": ["🥤 می‌نوشم", "🔥 آن را می‌جوشانم", "🚱 نمی‌خورم و رها می‌کنم", "🧼 با خاک تصفیه می‌کنم"],
"answer": 1,
"explanations": {
"0": "نوشیدن مستقیم ممکن است باعث بیماری شود.",
"1": "✅ جوشاندن آب ساده‌ترین روش تصفیه است.",
"2": "در شرایط بقا، منابع آب نباید رها شود.",
"3": "خاک ممکن است آلودگی را بیشتر کند."
}
},
{
"question": "🧗 [مرحله 78] باید از صخره‌ای بالا بروی، اما طناب نداری. چه می‌کنی؟",
"options": ["🪢 با لباس‌ها طناب می‌سازم", "🧱 صبر می‌کنم تا کمکی برسد", "🏃 از کناره می‌گردم", "🧎 بدون طناب بالا می‌روم"],
"answer": 0,
"explanations": {
"0": "✅ ساخت طناب از پارچه بهترین راه‌حل موقت است.",
"1": "کمک ممکن است هرگز نرسد.",
"2": "شاید مسیر جایگزین وجود نداشته باشد.",
"3": "بالا رفتن بدون طناب خطرناک است."
}
},
{
"question": "🧭 [مرحله 79] گم شده‌ای و قطب‌نما هم نداری. چطور جهت‌یابی می‌کنی؟",
"options": ["🌞 از موقعیت خورشید", "📱 از GPS گوشی", "🍃 با جهت وزش باد", "🐜 با مسیر مورچه‌ها"],
"answer": 0,
"explanations": {
"0": "✅ خورشید شرق و غرب را نشان می‌دهد.",
"1": "GPS بدون آنتن کار نمی‌کند.",
"2": "جهت باد تغییرپذیر است.",
"3": "مسیر مورچه‌ها اتفاقی است."
}
},
{
"question": "⚠️ [مرحله 80] حیوانی وحشی نزدیک کمپ شده است. چه می‌کنی؟",
"options": ["🔥 آتش روشن می‌کنم", "🎯 به او حمله می‌کنم", "🏃 فرار می‌کنم", "🧍 ساکن می‌مانم"],
"answer": 0,
"explanations": {
"0": "✅ حیوانات معمولاً از آتش می‌ترسند.",
"1": "حمله مستقیم خطرناک است.",
"2": "فرار باعث تحریک حمله می‌شود.",
"3": "بی‌حرکتی همیشه مفید نیست."
}
},
{
"question": "📶 [مرحله 81] گوشی‌ات فقط ۲ درصد شارژ دارد. از آن برای چه استفاده می‌کنی؟",
"options": ["📍 ارسال موقعیت مکانی", "🎮 بازی کردن برای روحیه", "📷 عکس گرفتن از حیوان", "🎵 گوش دادن به موسیقی"],
"answer": 0,
"explanations": {
"0": "✅ ارسال لوکیشن در اولویت نجات است.",
"1": "استفاده بی‌مورد باعث اتمام شارژ می‌شود.",
"2": "عکاسی ضروری نیست.",
"3": "موسیقی ممکن است حتی حیوانات را جذب کند."
}
},
{
"question": "🌧 [مرحله 82] باران شدیدی شروع شده. چه می‌کنی؟",
"options": ["🛖 به پناهگاه برمی‌گردم", "⛺ چادر جدید می‌زنم", "🚶 به مسیر ادامه می‌دهم", "🎣 ماهیگیری می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ پناهگاه امن‌ترین گزینه است.",
"1": "ساخت چادر زمان‌بر است.",
"2": "در باران دید کاهش می‌یابد.",
"3": "در باران ماهیگیری سخت است."
}
},
{
"question": "🐍 [مرحله 83] به مار برخورد کرده‌ای. چه واکنشی نشان می‌دهی؟",
"options": ["🏃 سریع دور می‌شوم", "🪓 به آن حمله می‌کنم", "🧍 بی‌حرکت می‌مانم", "🗣 با صدا می‌ترسانم"],
"answer": 3,
"explanations": {
"0": "فرار سریع ممکن است تحریکش کند.",
"1": "حمله ممکن است خطرناک‌تر شود.",
"2": "بی‌حرکتی کافی نیست.",
"3": "✅ مارها از صدا می‌ترسند و دور می‌شوند."
}
},
{
"question": "🏕 [مرحله 84] مکان جدیدی برای اردو زدن نیاز داری. کجا را انتخاب می‌کنی؟",
"options": ["🏞 کنار رودخانه", "🌄 بالای تپه", "🌳 زیر درخت بلند", "🪨 زمین صاف و باز"],
"answer": 3,
"explanations": {
"0": "کنار رودخانه خطر سیل دارد.",
"1": "بالای تپه در برابر باد آسیب‌پذیر است.",
"2": "درخت ممکن است در طوفان خطرناک باشد.",
"3": "✅ زمین باز و صاف ایمن‌ترین گزینه است."
}
},
{
"question": "🔦 [مرحله 85] شب‌هنگام صدای خش‌خش عجیبی می‌شنوی. چه می‌کنی؟",
"options": ["🔦 با نور بررسی می‌کنم", "😴 بی‌توجه می‌خوابم", "📢 فریاد می‌زنم", "🔪 آماده حمله می‌شوم"],
"answer": 0,
"explanations": {
"0": "✅ بررسی با نور خطر را شناسایی می‌کند.",
"1": "نادیده گرفتن ممکن است فاجعه‌بار باشد.",
"2": "فریاد زدن بی‌دلیل خطر را بیشتر می‌کند.",
"3": "حمله نکن تا تهدید مشخص نشود."
}
},
{
"question": "📦 [مرحله 86] بسته‌ای پیدا کرده‌ای با نوشته «اورژانسی». چه می‌کنی؟",
"options": ["📖 بررسی محتویات", "🔥 آتش می‌زنم برای گرما", "🪓 باز نمی‌کنم", "📦 آن را مخفی می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ بررسی آن می‌تواند ابزار نجات باشد.",
"1": "سوزاندن آن اشتباه است.",
"2": "باز نکردن یعنی از دست دادن فرصت.",
"3": "مخفی کردن به‌درد نمی‌خورد."
}
},
{
"question": "🔊 [مرحله 87] صدای شلیک گلوله‌ای از دور شنیده‌ای. چه واکنشی نشان می‌دهی؟",
"options": ["🏃 به سمت صدا می‌دوم", "📣 علامت می‌دهم", "🔭 از دور بررسی می‌کنم", "🛌 بی‌حرکت می‌مانم"],
"answer": 2,
"explanations": {
"0": "حرکت بی‌فکرانه خطرناک است.",
"1": "علامت دادن بدون شناخت، اشتباه است.",
"2": "✅ بررسی از دور عاقلانه‌ترین کار است.",
"3": "بی‌حرکتی مفید نیست مگر خطر نزدیک باشد."
}
},
{
"question": "📜 [مرحله 88] نقشه‌ای که در مرحله ۵۳ پیدا کردی، حالا گم شده. چه می‌کنی؟",
"options": ["🧠 از حافظه‌ام کمک می‌گیرم", "🔍 به دنبال آن می‌گردم", "🧭 مسیر جدید می‌سازم", "🚶 مسیر را رها می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ اگر خوب بررسی شده باشد، حافظه کمک می‌کند.",
"1": "گشتن ممکن است زمان‌بر و بی‌نتیجه باشد.",
"2": "مسیرسازی جدید خطرناک است.",
"3": "رها کردن تصمیم منطقی نیست."
}
},
{
"question": "🛠 [مرحله 89] چاقوی بقایت کند شده. چه می‌کنی؟",
"options": ["🪨 آن را با سنگ تیز می‌کنم", "🗑️ دور می‌اندازم", "🪓 جایگزین می‌کنم", "🪵 از چوب استفاده می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ سنگ‌های صاف بهترین ابزار تیزکردن هستند.",
"1": "دور انداختن اشتباه است.",
"2": "جایگزین ممکن است وجود نداشته باشد.",
"3": "چوب کارایی چاقو را ندارد."
}
},
{
"question": "🧱 [مرحله 90] برای ساخت پناهگاه جدید مصالح نداری. چطور عمل می‌کنی؟",
"options": ["🍃 از برگ و شاخه استفاده می‌کنم", "🪓 درخت قطع می‌کنم", "🛑 صبر می‌کنم", "🏃 جابه‌جا می‌شوم"],
"answer": 0,
"explanations": {
"0": "✅ شاخه‌ها بهترین مصالح در دسترس‌اند.",
"1": "قطع درخت زمان‌بر و خطرناک است.",
"2": "صبر کمک نمی‌کند.",
"3": "جابه‌جایی باید آخرین گزینه باشد."
}
},
[
{
"question": "🧨 [مرحله 91] صدای انفجار در دوردست شنیده‌ای. چه می‌کنی؟",
"options": ["🔭 از بلندی بررسی می‌کنم", "🏃 به سمت صدا می‌دوم", "😴 بی‌تفاوت می‌مانم", "📣 علامت می‌دهم"],
"answer": 0,
"explanations": {
"0": "✅ بررسی از دور امن‌ترین راه است.",
"1": "حرکت به سمت صدا ممکن است خطرناک باشد.",
"2": "نادیده گرفتن ممکن است باعث از دست دادن فرصت شود.",
"3": "علامت دادن بدون بررسی ممکن است توجه ناخواسته جلب کند."
}
},
{
"question": "🧍‍♂️ [مرحله 92] فردی زخمی را در جنگل پیدا می‌کنی. اولین واکنش تو؟",
"options": ["🩹 بررسی زخم و کمک", "🏃 او را رها می‌کنم", "📢 داد می‌زنم", "😐 بی‌تفاوت رد می‌شوم"],
"answer": 0,
"explanations": {
"0": "✅ کمک به دیگران در طبیعت هم از نظر انسانی و هم بقایی مهم است.",
"1": "رها کردن غیراخلاقی و خطرناک است.",
"2": "داد زدن ممکن است حیوانات را جذب کند.",
"3": "بی‌تفاوتی می‌تواند به مرگ منجر شود."
}
},
{
"question": "⚠️ [مرحله 93] در مسیرت تابلوی هشدار حیوانات درنده می‌بینی. چه می‌کنی؟",
"options": ["🚫 مسیر را عوض می‌کنم", "🔫 آماده حمله می‌شوم", "🚶 سریع‌تر عبور می‌کنم", "😐 نادیده می‌گیرم"],
"answer": 0,
"explanations": {
"0": "✅ تغییر مسیر عاقلانه‌ترین تصمیم است.",
"1": "آمادگی بدون نیاز ممکن است استرس‌زا باشد.",
"2": "سرعت ممکن است حیوانات را تحریک کند.",
"3": "نادیده گرفتن تابلوی هشدار اشتباه بزرگی است."
}
},
{
"question": "📻 [مرحله 94] رادیوی قدیمی در یک کلبه پیدا کرده‌ای. چه می‌کنی؟",
"options": ["🔋 باتری آن را چک می‌کنم", "📦 با خود می‌برم", "💣 آن را باز می‌کنم", "📻 روشنش نمی‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ ممکن است با باتری کار کند و نجات را ممکن کند.",
"1": "بردن بدون بررسی فایده‌ای ندارد.",
"2": "باز کردن ممکن است خرابش کند.",
"3": "عدم استفاده یعنی از دست دادن شانس."
}
},
{
"question": "📦 [مرحله 95] در بسته‌ای قدیمی قرص‌هایی می‌یابی. چه می‌کنی؟",
"options": ["🧪 با احتیاط از آن استفاده می‌کنم", "🗑️ دور می‌ریزم", "💊 همه را می‌خورم", "😐 نادیده می‌گیرم"],
"answer": 0,
"explanations": {
"0": "✅ در شرایط اضطراری مصرف داروها با احتیاط ممکن است لازم باشد.",
"1": "دور ریختن ممکن است باعث از دست رفتن کمک شود.",
"2": "خوردن همه خطرناک است.",
"3": "نادیده گرفتن فرصت استفاده را می‌گیرد."
}
},
{
"question": "📣 [مرحله 96] تیم نجات از دور تو را می‌بیند اما دور می‌شود. چه می‌کنی؟",
"options": ["🔥 دود تولید می‌کنم", "🏃 به دنبال‌شان می‌دوم", "🔦 با نور اشاره می‌کنم", "🛌 صبر می‌کنم"],
"answer": 0,
"explanations": {
"0": "✅ دود علامتی قدرتمند برای جلب توجه است.",
"1": "دویدن ممکن است تو را خسته یا گم کند.",
"2": "نور در روز کمتر مؤثر است.",
"3": "صبر کردن باعث از دست رفتن فرصت می‌شود."
}
},
{
"question": "🧱 [مرحله 97] پناهگاهت در حال تخریب است. چه کار می‌کنی؟",
"options": ["🔨 بازسازی سریع با مواد موجود", "🏃 رها می‌کنم و می‌روم", "📦 وسایل را می‌سوزانم", "🛌 داخلش می‌مانم"],
"answer": 0,
"explanations": {
"0": "✅ بازسازی سریع، اولویت دارد تا از خطر محافظت شوی.",
"1": "ترک پناهگاه در شب خطرناک است.",
"2": "سوزاندن وسایل اشتباه است.",
"3": "ماندن در پناهگاه خراب ممکن است جان‌باختگی ایجاد کند."
}
},
{
"question": "🗣 [مرحله 98] صدای انسانی از دور شنیده می‌شود. چه می‌کنی؟",
"options": ["📣 پاسخ می‌دهم", "🏃 دنبال صدا می‌دوم", "🤫 ساکت می‌مانم", "🧭 دور می‌زنم"],
"answer": 0,
"explanations": {
"0": "✅ ارتباط صوتی ممکن است به نجات منجر شود.",
"1": "دویدن بدون دید ممکن است خطرناک باشد.",
"2": "سکوت شانس کمک گرفتن را از بین می‌برد.",
"3": "دور زدن بدون شناسایی دقیق فایده ندارد."
}
},
{
"question": "🎯 [مرحله 99] تنها راه خروج عبور از رودخانه‌ای عمیق است. چطور عمل می‌کنی؟",
"options": ["🛶 قایق می‌سازم", "🏊‍♂️ شنا می‌کنم", "🚧 دنبال پل می‌گردم", "⛔ منصرف می‌شوم"],
"answer": 2,
"explanations": {
"0": "ساخت قایق وقت‌گیر و خطرناک است.",
"1": "شنا در رودخانه عمیق خطرناک است.",
"2": "✅ پل ایمن‌ترین مسیر عبور است.",
"3": "منصرف شدن بدون دلیل یعنی ماندن در خطر."
}
},
{
"question": "🎉 [مرحله 100] پس از روزها رنج، تیم نجات به تو رسیده! اولین اقدامت چیست؟",
"options": ["📢 فریاد خوشحالی", "🧍 آرام و منطقی رفتار می‌کنی", "📦 وسایل را جمع می‌کنی", "🤳 سلفی می‌گیری"],
"answer": 1,
"explanations": {
"0": "هیجان قابل درک است ولی مهم حفظ آرامش است.",
"1": "✅ خونسردی و همکاری با تیم نجات مهم است.",
"2": "جمع وسایل اولویت ندارد.",
"3": "سلفی گرفتن باید آخرین کار باشد."
}
}
]


        
   
    with open(QUESTIONS_FILE, "w") as f:
        json.dump(sample_questions, f)

with open(QUESTIONS_FILE) as f:
    QUESTIONS = json.load(f)

def save_users(users):
    with open(DATA_FILE, "w") as f:
        json.dump(users, f)

def load_users():
    with open(DATA_FILE) as f:
        return json.load(f)

def check_name(m):
    users = load_users()
    user_id = str(m.chat.id)
    
    # اگر پیام /start بود، اجازه دهید پردازش شود
    if m.text and m.text.startswith('/start'):
        return True
    
    # بررسی وجود کاربر و نام
    return user_id in users and "name" in users[user_id] and users[user_id]["name"].strip() != ""
    
def is_member(user_id):
    try:
        status = bot.get_chat_member(CHANNEL_USERNAME, user_id).status
        return status in ['member', 'creator', 'administrator']
    except:
        return False

def main_menu():
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add("🎮 شروع بازی", "🏆 برترین ها")
    markup.add("🛒 فروشگاه", "🧑‍🤝‍🧑 دعوت دوستان")
    markup.add("👤 پروفایل", "🎁 پاداش روزانه")
    return markup

@bot.message_handler(func=lambda m: m.reply_to_message and "نام خود را وارد کن" in m.reply_to_message.text)
def process_name(m):
    text = m.text or ""
    if text.startswith("/"):
        bot.send_message(m.chat.id, "❗️نام معتبر نیست. لطفاً فقط نام خود را وارد کنید:")
        return

    users = load_users()
    users[str(m.chat.id)]["name"] = text.strip()
    save_users(users)
    bot.send_message(m.chat.id, f"✅ ثبت شد: {text.strip()}", reply_markup=main_menu())
@bot.message_handler(commands=['start'])
def handle_start(m):
    user_id = str(m.chat.id)
    users = load_users()
    
    # بررسی عضویت در کانال
    if not is_member(user_id):
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("📢 عضویت در کانال", url=f"https://t.me/{CHANNEL_USERNAME.lstrip('@')}"))
        bot.send_message(user_id, "📛 برای استفاده از ربات، ابتدا باید در کانال عضو شوید:", reply_markup=markup)
        return
    
    # ایجاد کاربر جدید اگر وجود ندارد
    if user_id not in users:
        users[user_id] = {
            "name": "",
            "life": 3,
            "coin": 0,
            "score": 0,
            "step": 0,
            "last_bonus": ""
        }
        save_users(users)
    
    # اگر نام کاربر خالی است
    if not users[user_id]["name"]:
        msg = bot.send_message(user_id, "👤 لطفاً نام واقعی خود را وارد کنید (حداقل 2 حرف):", 
                             reply_markup=types.ForceReply(selective=True))
        bot.register_next_step_handler(msg, process_name)  # اینجا تابع process_name فراخوانی می‌شود
    else:
        bot.send_message(user_id, f"🔹 سلام {users[user_id]['name']}!", reply_markup=main_menu())

# 🎮 بازی
@bot.message_handler(func=lambda m: m.text == "🎮 شروع بازی")
def start_game(m):
    user_id = str(m.chat.id)
    users = load_users()

    if user_id not in users:
        bot.send_message(m.chat.id, "❗️ ابتدا باید ثبت‌نام کنید. /start")
        return

    user = users[user_id]
    user.setdefault("step", 0)  # مقدار پیش‌فرض اگر وجود نداشته باشد
    user.setdefault("life", 3)
    user.setdefault("coin", 0)
    user.setdefault("score", 0)

    # ذخیره تغییرات اولیه
    save_users(users)

    # بارگذاری سوالات
    with open(QUESTIONS_FILE, "r") as f:
        questions = json.load(f)

    # بررسی اگر کاربر تمام مراحل را گذرانده باشد
    if user["step"] >= len(questions):
        bot.send_message(m.chat.id, "🎉 شما تمام مراحل را کامل کرده‌اید! به زودی مراحل جدید اضافه خواهد شد.")
        return

    # ارسال سوال از مرحله‌ای که کاربر قبلاً رسیده بود
    q = questions[user["step"]]
    markup = types.InlineKeyboardMarkup()
    for i, opt in enumerate(q["options"]):
        markup.add(types.InlineKeyboardButton(opt, callback_data=f"q_{i}"))

    bot.send_message(m.chat.id, f"{q['question']}", reply_markup=markup)

def is_valid_answer(m):
    users = load_users()
    user_id = str(m.chat.id)
    
    if user_id not in users:
        return False
        
    user = users[user_id]
    step = user.get("step", 0)
    
    if step >= len(QUESTIONS):
        return False
    
    q = QUESTIONS[step]
    # بررسی تطابق دقیق متن پیام با گزینه‌ها (با حذف فاصله‌های اضافی)
    return any(m.text.strip() == opt.strip() for opt in q["options"])

@bot.message_handler(func=is_valid_answer)
def answer_question(m):
    users = load_users()
    user = users[str(m.chat.id)]
    step = user["step"]

    q = questions[step]
    options = q["options"]
    explanations = q["explanations"]
    correct_index = q["answer"]

    selected_index = options.index(m.text.strip())

    if selected_index == correct_index:
        user["coin"] += 10
        user["score"] += 20
        result = f"✅ درست گفتی!\n📘 توضیح: {explanations[selected_index]}"
    else:
        user["score"] += 5
        result = f"❌ اشتباه بود!\n📘 توضیح: {explanations[selected_index]}"

    all_expl = "\n\n📖 توضیح تمام گزینه‌ها:\n"
    for i, opt in enumerate(options):
        mark = "✅" if i == correct_index else "❌"
        all_expl += f"{mark} {opt}: {explanations[i]}\n"

    bot.send_message(m.chat.id, result + all_expl)

    user["step"] += 1
    save_users(users)

    if user["step"] < len(questions):
        send_question(m.chat.id)
    else:
        bot.send_message(m.chat.id, "🏁 تمام مراحل به پایان رسید!")

@bot.message_handler(func=lambda m: m.text == "🔙 بازگشت به منو")
def back_to_menu(m):
    bot.send_message(m.chat.id, "↩️ بازگشت به منو", reply_markup=main_menu())

# 🛒 فروشگاه - منو
@bot.message_handler(func=lambda m: m.text == "🛒 فروشگاه")
def shop(m):
    msg = f"""🛒 فروشگاه:

💰 قیمت ۱۰۰ سکه = ۴ ترون  
💳 آدرس ترون: `{TRON_ADDRESS}`

✅ پس از پرداخت، همین پیام را ریپلای و فیش را ارسال کنید (عکس یا متن).


📍 همچنین می‌توانید با ۱۰۰ سکه، ۱ ❤️ جان بخرید:
برای خرید جان، گزینه زیر را انتخاب کنید:
"""
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("🧡 خرید جان (۱۰۰ سکه)", "🔙 بازگشت به منو")
    bot.send_message(m.chat.id, msg, reply_markup=markup, parse_mode="Markdown")

# ❤️ خرید جان با ۱۰۰ سکه
@bot.message_handler(func=lambda m: m.text == "🧡 خرید جان (۱۰۰ سکه)")
def buy_life(m):
    users = load_users()
    u = users[str(m.chat.id)]
    if u["coin"] >= 100:
        u["coin"] -= 100
        u["life"] += 1
        save_users(users)
        bot.send_message(m.chat.id, "🧡 یک جان با موفقیت خریداری شد! ❤️")
    else:
        bot.send_message(m.chat.id, "❌ شما سکه کافی برای خرید جان ندارید.")

# 💳 ارسال فیش پرداخت (درخواست)
@bot.message_handler(content_types=['photo'])
def handle_photo_payment(m):
    # بررسی کن که آیا این عکس پاسخ به پیام درخواست فیش است
    if m.reply_to_message and "فیش" in m.reply_to_message.text and m.text != "💳 ارسال فیش پرداخت":
        file_id = m.photo[-1].file_id
        caption = f"📥 فیش پرداخت تصویری از {m.from_user.first_name}"
        bot.send_photo(ADMIN_ID, file_id, caption=caption, reply_markup=payment_markup(m.chat.id))
    else:
        bot.send_message(m.chat.id, "📸 لطفاً فیش پرداخت را به صورت *عکس* یا *متن* ارسال کن:", reply_markup=types.ForceReply(selective=True), parse_mode="Markdown")
# 📤 دریافت فیش پرداخت و ارسال برای ادمین
@bot.message_handler(func=lambda m: m.reply_to_message and "فیش" in m.reply_to_message.text and m.text != "💳 ارسال فیش پرداخت")
def handle_payment(m):
    msg = f"📥 فیش پرداخت جدید از {m.from_user.first_name}:\n\n"
    if m.content_type == "photo":
        file_id = m.photo[-1].file_id
        bot.send_photo(ADMIN_ID, file_id, caption=msg + "(فیش تصویری)", reply_markup=payment_markup(m.chat.id))
    else:
        bot.send_message(ADMIN_ID, msg + m.text, reply_markup=payment_markup(m.chat.id))

# ✅ دکمه‌های تایید / رد برای ادمین
def payment_markup(user_id):
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("✅ تایید", callback_data=f"approve_{user_id}"))
    markup.add(types.InlineKeyboardButton("❌ رد", callback_data=f"reject_{user_id}"))
    return markup

# ✅ تایید پرداخت توسط ادمین
@bot.callback_query_handler(func=lambda call: call.data.startswith("approve_"))
def approve_payment(call):
    user_id = call.data.split("_")[1]
    users = load_users()
    users[user_id]["coin"] += 100
    save_users(users)
    bot.send_message(int(user_id), "✅ پرداخت شما تایید شد! ۱۰۰ سکه به حساب شما اضافه شد.")
    bot.answer_callback_query(call.id, "پرداخت تایید شد.")

# ❌ رد پرداخت توسط ادمین با پیام دقیق‌تر
@bot.callback_query_handler(func=lambda call: call.data.startswith("reject_"))
def reject_payment(call):
    user_id = call.data.split("_")[1]
    bot.send_message(int(user_id), "❌ رسید پرداخت شما توسط ادمین رد شد.\nلطفاً بررسی و در صورت نیاز، مجدداً ارسال کنید.")
    bot.answer_callback_query(call.id, "رد شد.")

# 👤 پروفایل
@bot.message_handler(func=lambda m: m.text == "👤 پروفایل")
def profile(m):
    users = load_users()
    u = users[str(m.chat.id)]
    msg = f"""👤 نام: {u['name']}
❤️ جان: {u['life']}
💰 سکه: {u['coin']}
⭐️ امتیاز: {u['score']}"""
    bot.send_message(m.chat.id, msg)

# 🎁 پاداش روزانه
@bot.message_handler(func=lambda m: m.text == "🎁 پاداش روزانه")
def daily_bonus(m):
    users = load_users()
    user_id = str(m.chat.id)
    
    if user_id not in users:
        bot.send_message(m.chat.id, "❌ خطا در یافتن اطلاعات کاربر. لطفاً با /start مجدداً شروع کنید.")
        return
    
    user = users[user_id]
    now = datetime.datetime.now()
    
    # اگر last_bonus وجود ندارد یا خالی است
    if "last_bonus" not in user or not user["last_bonus"]:
        user["last_bonus"] = "2000-01-01 00:00:00"
    
    try:
        last = datetime.datetime.strptime(user["last_bonus"], "%Y-%m-%d %H:%M:%S")
    except ValueError:
        last = datetime.datetime.min
        user["last_bonus"] = "2000-01-01 00:00:00"
    
    delta = now - last
    
    # تغییر به 12 ساعت (43200 ثانیه)
    if delta.total_seconds() >= 43200:
        user["coin"] += 10
        user["last_bonus"] = now.strftime("%Y-%m-%d %H:%M:%S")
        save_users(users)
        bot.send_message(m.chat.id, "🎉 ۱۰ سکه پاداش دریافت کردید!")
    else:
        remaining = 43200 - delta.total_seconds()
        hours = int(remaining // 3600)
        minutes = int((remaining % 3600) // 60)
        bot.send_message(m.chat.id, f"⏳ باید {hours} ساعت و {minutes} دقیقه دیگر صبر کنید.")
# 🧑‍🤝‍🧑 دعوت
@bot.message_handler(func=lambda m: m.text == "🧑‍🤝‍🧑 دعوت دوستان")
def invite(m):
    link = f"https://t.me/{bot.get_me().username}?start={m.chat.id}"
    bot.send_message(m.chat.id, f"📨 لینک دعوت شما:\n{link}\nهر دعوت = ۵۰ سکه")

# 🎖️ برترین‌ها
@bot.message_handler(func=lambda m: m.text == "🏆 برترین ها")
def top_players(m):
    users = load_users()
    sorted_users = sorted(users.items(), key=lambda x: x[1]["score"], reverse=True)
    text = "🏆 ۱۰ بازیکن برتر:\n"
    for i, (uid, u) in enumerate(sorted_users[:10]):
        text += f"{i+1}. {u['name']} - {u['score']} امتیاز\n"
    bot.send_message(m.chat.id, text)

# 🌐 Flask برای دیپلوی در Render
@app.route(f"/{API_TOKEN}", methods=["POST"])
def webhook():
    bot.process_new_updates([telebot.types.Update.de_json(request.stream.read().decode("utf-8"))])
    return "OK"

@app.route("/", methods=["GET"])
def index():
    return "بات فعال است"

def run():
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 5000)))

def set_webhook():
    bot.remove_webhook()
    bot.set_webhook(url=f"https://bagha-2qv0.onrender.com/{API_TOKEN}")  # 🔁 آدرس دقیق Render

@bot.message_handler(func=lambda m: True)
def block_if_no_name(m):
    if not check_name(m):
        if m.text != "/start":
            bot.send_message(m.chat.id, "❗️ لطفاً ابتدا نام خود را وارد کنید. /start")

def get_user_step(user_id):
    users = load_users()
    return users.get(str(user_id), {}).get("step", -1)

def send_question(chat_id):
    users = load_users()
    user_id = str(chat_id)
    
    if user_id not in users:
        return
        
    user = users[user_id]
    step = user["step"]
    
    if step < len(QUESTIONS):
        q = QUESTIONS[step]
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        
        # اضافه کردن گزینه‌ها با شماره
        for i, opt in enumerate(q["options"]):
            markup.add(f"{i+1}. {opt}")
            
        markup.add("🔙 بازگشت به منو")
        bot.send_message(chat_id, q["question"], reply_markup=markup)
    else:
        bot.send_message(chat_id, "🎉 شما همه مراحل را کامل کردید! به زودی مراحل جدید اضافه خواهد شد.")
def is_valid_answer(m):
    users = load_users()
    user = users.get(str(m.chat.id))
    if not user:
        return False

    step = user.get("step", -1)
    if step < 0 or step >= len(questions):  # توجه: questions همون لیست سوالاته
        return False

    q = questions[step]
    return m.text.strip() in q["options"]
    # بررسی آیا متن پیام با یکی از گزینه‌ها مطابقت دارد
    return any(m.text.strip() == opt for opt in q["options"])

@bot.message_handler(func=lambda m: True)
def handle_all_messages(m):
    # اجازه پردازش /start در هر حالت
    if m.text and m.text.startswith('/start'):
        return
        
    users = load_users()
    user_id = str(m.chat.id)
    
    # بررسی آیا کاربر ثبت نام کرده است
    if user_id not in users or not users[user_id].get("name"):
        bot.send_message(m.chat.id, "❗️ لطفاً ابتدا با دستور /start ثبت نام کنید.")
        return
        
    # اگر پیام مربوط به بازی است
    if is_valid_answer(m):
        answer_question(m)
        return
        
    # سایر پیام‌ها
    bot.send_message(m.chat.id, "⚠️ لطفاً از منوی اصلی انتخاب کنید.", reply_markup=main_menu())

@bot.callback_query_handler(func=lambda call: call.data.startswith("q_"))
def handle_question_answer(call):
    chat_id = call.message.chat.id
    user_id = str(chat_id)

    # بارگذاری اطلاعات کاربر و سوالات
    users = load_users()
    with open(QUESTIONS_FILE, "r") as f:
        questions = json.load(f)

    user = users.get(user_id)
    if not user:
        bot.answer_callback_query(call.id, "❌ خطا در یافتن اطلاعات کاربر.")
        return

    current_step = user.get("step", 0)
    if current_step >= len(questions):
        bot.answer_callback_query(call.id, "✅ شما تمام مراحل را گذرانده‌اید!")
        return

    question = questions[current_step]
    selected_option = int(call.data.split("_")[1])
    correct = selected_option == question["answer"]

    # ساخت متن توضیحات
    explanation_text = ""
    for idx, opt in enumerate(question["options"]):
        mark = "✅" if idx == question["answer"] else ("❌" if idx == selected_option else "▫️")
        explanation_text += f"{mark} {opt}\n— {question['explanations'].get(idx, '')}\n\n"

    # بروزرسانی اطلاعات کاربر
    if correct:
        user["score"] += 20
        user["coin"] += 10
        result_message = "✅ پاسخ درست! +۲۰ امتیاز و +۱۰ سکه."
    else:
        user["score"] += 5
        user["life"] -= 1
        result_message = "❌ پاسخ اشتباه! +۵ امتیاز و -۱ جان."

    # افزایش مرحله فقط اگر کاربر هنوز جان دارد
    if user["life"] > 0:
        user["step"] += 1
    else:
        bot.send_message(chat_id, "💔 جان شما تمام شد! برای ادامه، جان خریداری کنید.", reply_markup=main_menu())

    # ذخیره تغییرات
    save_users(users)

    # نمایش نتیجه به کاربر
    bot.edit_message_text(
        f"{result_message}\n\n📝 توضیحات:\n{explanation_text}",
        chat_id,
        call.message.message_id
    )

    # ارسال سوال بعدی اگر کاربر جان دارد و مرحله تمام نشده باشد
    if user["life"] > 0 and user["step"] < len(questions):
        next_q = questions[user["step"]]
        markup = types.InlineKeyboardMarkup()
        for i, opt in enumerate(next_q["options"]):
            markup.add(types.InlineKeyboardButton(opt, callback_data=f"q_{i}"))
        bot.send_message(chat_id, f"{next_q['question']}", reply_markup=markup)
    elif user["step"] >= len(questions):
        bot.send_message(chat_id, "🎉 تبریک! شما تمام مراحل را کامل کردید!")
            
if __name__ == "__main__":
    Thread(target=run).start()
